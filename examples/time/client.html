<!DOCTYPE html>
<!-- when running from file, add option --allow-file-access-from-files -->
<html>
<head>
<meta charset="utf-8" />
<script>
	var websocket, address, log, connected, error

	function onMessage(e) {
		message = JSON.parse(e.data)

		for (var i = 0; i < message.Data.length; i++) {
			var p = document.createElement("p")
			p.innerHTML = message.Data[i][1] + " " + message.Data[i][2]
			// .timezone
			// p.innerHTML += message.Data[i].current_time
			log.appendChild(p)
		}
	}

	function onClose() {
		connected.style.backgroundColor = "red"
	}

	function onError(e) {
		error = e
	}

	function send() {
		try {
			websocket.send(JSON.stringify({
				Operation: "<~",
				Collection: "request",
				Data: [["127.0.0.1:3000", address, timezone.value]]
			}))
		} catch (e) {
			alert(e)
		}
	}

	function init() {
		log = document.getElementById("log")
		connected = document.getElementById("connected")
		timezone = document.getElementById("timezone")

		// connect to the monitor server
		websocket = new WebSocket("ws://127.0.0.1:8000/wsjson");
		websocket.onmessage = onMessage;
		websocket.onclose = onClose;
		websocket.onerror = onError;
		
		// set uniq id (address)
		websocket.onopen = function() {
			address = Math.random().toString(36).substr(2)
			try {
				websocket.send(JSON.stringify(address))
			} catch (e) {
				alert(e)
			}

			connected.style.backgroundColor = "green"
			// connected.innerHTML = address
		}
	}

	window.addEventListener("load", init, false)
</script>
</head>
<body>
<div id="connected" style="width:20px; height:20px; background-color:red">&nbsp;</div>
<div>
	<!-- <textarea id="timezone">America/New_York</textarea><br/> -->
	<form onsubmit="send(); return false;">
		<input type="text" id="timezone" value="America/New_York" />
		<input type="submit" value="Get Current Time In" onclick="send()"/>
	</form>
</div>
<div id="log">
</div>
</body>
</html>